{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='high3.css') }}">
{% endblock %}

{% block content %}

<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loader-container">
        <div class="purple-dot-loader">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <p class="loading-text">데이터 및 생기부 분석 중입니다... 잠시만 기다려주세요 ! ✨</p>
    </div>
</div>

<div class="high3-container">
    <h1 class="high3-title">고3/N수 입시 분석</h1>
    <p class="high3-sub">목표 대학과 성적, 생기부를 등록해주세요</p>

    <form action="/high3_result" method="POST" enctype="multipart/form-data"
          class="form-card wide" id="analysis-form">

        <!-- 1. 목표 대학 -->
        <h3 class="section-title">1. 목표 대학</h3>
        <div class="input-group">
            <select name="school" id="school-select" class="select-box" required>
                <option value="">학교 선택</option>
                {% for school in schools %}
                    <option value="{{ school }}">{{ school }}</option>
                {% endfor %}
            </select>

            <select name="major" id="major-select" class="select-box" required>
                <option value="">학과 선택</option>
            </select>
        </div>

        <!-- 2. 성적 입력 -->
        <h3 class="section-title">2. 성적 입력</h3>

        <!-- 등급 -->
        <p class="score-sub-title">등급</p>
        <div class="score-grid compact">
            <div class="score-item">
                <label class="label">국어</label>
                <input type="number" name="kor_grade" min="1" max="9" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">수학</label>
                <input type="number" name="math_grade" min="1" max="9" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">영어</label>
                <input type="number" name="eng_grade" min="1" max="9" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">탐구 1</label>
                <input type="number" name="inq1_grade" min="1" max="9" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">탐구 2</label>
                <input type="number" name="inq2_grade" min="1" max="9" class="score-input" required>
            </div>
        </div>

        <!-- 백분위 -->
        <p class="score-sub-title">백분위</p>
        <div class="score-grid compact">
            <div class="score-item">
                <label class="label">국어</label>
                <input type="number" name="kor_percent" min="0" max="100" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">수학</label>
                <input type="number" name="math_percent" min="0" max="100" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">탐구 1</label>
                <input type="number" name="inq1_percent" min="0" max="100" class="score-input" required>
            </div>
            <div class="score-item">
                <label class="label">탐구 2</label>
                <input type="number" name="inq2_percent" min="0" max="100" class="score-input" required>
            </div>
        </div>

        <!-- 3. 생기부 PDF -->
        <h3 class="section-title">3. 생기부 PDF 업로드</h3>
        <div class="file-upload-wrapper">
            <span class="file-label-text" id="file-name">
                파일을 클릭하거나 여기에 드래그하세요 (PDF)
            </span>
            <input type="file" name="pdf_file" id="pdf-file" accept=".pdf" required>
        </div>

        <button type="submit" id="start-btn" class="submit-btn">
            분석 시작하기
        </button>

    </form>
</div>

<!-- 하단 고정 버튼 -->
<div class="sticky-bottom-bar">
    <button type="button" id="sticky-start-btn" class="sticky-btn" disabled>
        데이터 분석 시작하기
    </button>
</div>

<script>
    const majorMap = {{ major_map|tojson }};
    const form = document.getElementById("analysis-form");
    const schoolSelect = document.getElementById("school-select");
    const majorSelect = document.getElementById("major-select");
    const pdfInput = document.getElementById("pdf-file");
    const fileNameDisplay = document.getElementById("file-name");
    const startBtn = document.getElementById("start-btn");
    const stickyBtn = document.getElementById("sticky-start-btn");
    const loadingOverlay = document.getElementById("loading-overlay");

    schoolSelect.addEventListener("change", () => {
        majorSelect.innerHTML = '<option value="">학과 선택</option>';
        if (!schoolSelect.value) return;
        majorMap[schoolSelect.value].forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
        });
    });

    pdfInput.addEventListener("change", () => {
        if (pdfInput.files.length > 0) {
            fileNameDisplay.textContent = "선택됨: " + pdfInput.files[0].name;
            fileNameDisplay.style.color = "#3182f6";
        }
    });

    form.addEventListener("input", () => {
        stickyBtn.disabled = !form.checkValidity();
    });

    stickyBtn.addEventListener("click", () => form.requestSubmit());

    form.onsubmit = () => {
        startBtn.disabled = true;
        stickyBtn.disabled = true;
        startBtn.textContent = stickyBtn.textContent = "분석 중...";
        if (loadingOverlay) {
            loadingOverlay.style.display = "flex";
        }
    };
</script>
{% endblock %}
